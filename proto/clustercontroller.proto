syntax = "proto3";

package clustercontroller;

option go_package = "github.com/globulario/services/golang/clustercontroller/clustercontrollerpb;clustercontrollerpb";

import "google/protobuf/timestamp.proto";
import "plan.proto";

message ClusterInfo {
  string cluster_id = 1;
  string cluster_domain = 2;
  google.protobuf.Timestamp created_at = 3;
}

message ClusterNetworkSpec {
  string cluster_domain = 1;
  string protocol = 2;
  uint32 port_http = 3;
  uint32 port_https = 4;
  repeated string alternate_domains = 5;
  bool acme_enabled = 6;
  string admin_email = 7;
}

message NodeIdentity {
  string hostname = 1;
  string domain = 2;
  repeated string ips = 3;
  string os = 4;
  string arch = 5;
  string agent_version = 6;
}

message NodeRecord {
  string node_id = 1;
  NodeIdentity identity = 2;
  google.protobuf.Timestamp last_seen = 3;
  string status = 4;
  repeated string profiles = 5;
  map<string,string> metadata = 6;
  string agent_endpoint = 7;
}

message CreateJoinTokenRequest {
  google.protobuf.Timestamp expires_at = 1;
}
message CreateJoinTokenResponse {
  string join_token = 1;
  google.protobuf.Timestamp expires_at = 2;
}

message RequestJoinRequest {
  string join_token = 1;
  NodeIdentity identity = 2;
  map<string,string> labels = 3;
}
message RequestJoinResponse {
  string request_id = 1;
  string status = 2;
  string message = 3;
}

message GetJoinRequestStatusRequest {
  string request_id = 1;
}
message GetJoinRequestStatusResponse {
  string status = 1;
  string node_id = 2;
  repeated string profiles = 3;
  string message = 4;
}

message JoinRequestRecord {
  string request_id = 1;
  NodeIdentity identity = 2;
  string status = 3;
  string message = 4;
  repeated string profiles = 5;
  map<string,string> metadata = 6;
}

message ListJoinRequestsRequest {}
message ListJoinRequestsResponse {
  repeated JoinRequestRecord pending = 1;
}

message ApproveJoinRequest {
  string request_id = 1;
  string node_id = 2 [deprecated = true];
  repeated string profiles = 3;
  map<string,string> metadata = 4;
}
message ApproveJoinResponse {
  string node_id = 1;
  string message = 2;
}

message RejectJoinRequest {
  string request_id = 1;
  string node_id = 2 [deprecated = true];
  string reason = 3;
}
message RejectJoinResponse {
  string node_id = 1;
  string message = 2;
}

message ListNodesRequest {}
message ListNodesResponse {
  repeated NodeRecord nodes = 1;
}

message SetNodeProfilesRequest {
  string node_id = 1;
  repeated string profiles = 2;
}
message SetNodeProfilesResponse {
  string operation_id = 1;
}

// RemoveNode removes a node from the cluster.
// The node's services will be stopped and it will be deregistered.
message RemoveNodeRequest {
  string node_id = 1;
  bool force = 2;        // Force removal even if node is unreachable
  bool drain = 3;        // Stop services gracefully before removal
}
message RemoveNodeResponse {
  string operation_id = 1;
  string message = 2;
}

// GetClusterHealth returns the overall health status of the cluster.
message GetClusterHealthRequest {}
message GetClusterHealthResponse {
  string status = 1;     // healthy, degraded, unhealthy
  int32 total_nodes = 2;
  int32 healthy_nodes = 3;
  int32 unhealthy_nodes = 4;
  int32 unknown_nodes = 5;
  repeated NodeHealthStatus node_health = 6;
}

message NodeHealthStatus {
  string node_id = 1;
  string hostname = 2;
  string status = 3;     // healthy, unhealthy, unknown
  string last_error = 4;
  google.protobuf.Timestamp last_seen = 5;
  int32 failed_checks = 6;
}

message UpdateClusterNetworkRequest {
  ClusterNetworkSpec spec = 1;
}
message UpdateClusterNetworkResponse {
  uint64 generation = 1;
}

message ApplyNodePlanRequest {
  string node_id = 1;
}
message ApplyNodePlanResponse {
  string operation_id = 1;
}

enum ArtifactKind {
  ARTIFACT_KIND_UNSPECIFIED = 0;
  ARTIFACT_SERVICE = 1;
  ARTIFACT_APPLICATION = 2;
  ARTIFACT_SUBSYSTEM = 3;
}

message ArtifactRef {
  ArtifactKind kind = 1;
  string name = 2;
  string publisher = 3;
  string version = 4;
  string discovery_id = 5;
}

message UnitAction {
  string unit_name = 1;
  string action = 2;
}

// Deprecated: use globular.plan.v1.NodePlan with the V1 plan APIs.
message NodePlan {
  string node_id = 1;
  repeated string profiles = 2;
  repeated ArtifactRef ensure_installed = 3;
  repeated UnitAction unit_actions = 4;
  map<string,string> rendered_config = 5;
}

message UpgradeGlobularRequest {
  string node_id = 1;
  string platform = 2;
  bytes artifact = 3;
  string sha256 = 4;
  string target_path = 5;
  uint32 probe_port = 6;
}

message UpgradeGlobularResponse {
  string plan_id = 1;
  uint64 generation = 2;
  string terminal_state = 3;
  string error_step_id = 4;
  string error_message = 5;
}

message GetNodePlanRequest {
  string node_id = 1;
}
message GetNodePlanResponse {
  NodePlan plan = 1;
}

message GetNodePlanV1Request {
  string node_id = 1;
}
message GetNodePlanV1Response {
  globular.plan.v1.NodePlan plan = 1;
}

message ReconcileNodeV1Request {
  string node_id = 1;
}
message ReconcileNodeV1Response {}

message WatchNodePlanStatusV1Request {
  string node_id = 1;
}

message StartApplyRequest {
  string node_id = 1;
}
message StartApplyResponse {
  string operation_id = 1;
}

enum OperationPhase {
  OP_PHASE_UNSPECIFIED = 0;
  OP_QUEUED = 1;
  OP_RUNNING = 2;
  OP_SUCCEEDED = 3;
  OP_FAILED = 4;
}

message OperationEvent {
  string operation_id = 1;
  string node_id = 2;
  OperationPhase phase = 3;
  string message = 4;
  int32 percent = 5;
  bool done = 6;
  string error = 7;
  google.protobuf.Timestamp ts = 8;
}

message CompleteOperationRequest {
  string operation_id = 1;
  string node_id = 2;
  bool success = 3;
  string message = 4;
  string error = 5;
  int32 percent = 6;
}

message CompleteOperationResponse {
  string message = 1;
}

message NodeUnitStatus {
  string name = 1;
  string state = 2;
  string details = 3;
}

message NodeStatus {
  string node_id = 1;
  NodeIdentity identity = 2;
  repeated string ips = 3;
  repeated NodeUnitStatus units = 4;
  string last_error = 5;
  google.protobuf.Timestamp reported_at = 6;
  string agent_endpoint = 7;
}

message ReportNodeStatusRequest {
  NodeStatus status = 1;
}

message ReportNodeStatusResponse {
  string message = 1;
}

message WatchOperationsRequest {
  string node_id = 1;
  string operation_id = 2;
}

service ClusterControllerService {
  rpc GetClusterInfo(google.protobuf.Timestamp) returns (ClusterInfo);

  rpc CreateJoinToken(CreateJoinTokenRequest) returns (CreateJoinTokenResponse);
  rpc RequestJoin(RequestJoinRequest) returns (RequestJoinResponse);
  rpc ListJoinRequests(ListJoinRequestsRequest) returns (ListJoinRequestsResponse);
  rpc ApproveJoin(ApproveJoinRequest) returns (ApproveJoinResponse);
  rpc RejectJoin(RejectJoinRequest) returns (RejectJoinResponse);

  rpc ListNodes(ListNodesRequest) returns (ListNodesResponse);
  rpc SetNodeProfiles(SetNodeProfilesRequest) returns (SetNodeProfilesResponse);
  rpc RemoveNode(RemoveNodeRequest) returns (RemoveNodeResponse);
  rpc GetClusterHealth(GetClusterHealthRequest) returns (GetClusterHealthResponse);
  rpc GetNodePlan(GetNodePlanRequest) returns (GetNodePlanResponse);
  rpc GetNodePlanV1(GetNodePlanV1Request) returns (GetNodePlanV1Response);
  rpc ReconcileNodeV1(ReconcileNodeV1Request) returns (ReconcileNodeV1Response);
  rpc WatchNodePlanStatusV1(WatchNodePlanStatusV1Request) returns (stream globular.plan.v1.NodePlanStatus);
  rpc UpdateClusterNetwork(UpdateClusterNetworkRequest) returns (UpdateClusterNetworkResponse);
  rpc ApplyNodePlan(ApplyNodePlanRequest) returns (ApplyNodePlanResponse);
  rpc ReportNodeStatus(ReportNodeStatusRequest) returns (ReportNodeStatusResponse);
  rpc GetJoinRequestStatus(GetJoinRequestStatusRequest) returns (GetJoinRequestStatusResponse);
  rpc UpgradeGlobular(UpgradeGlobularRequest) returns (UpgradeGlobularResponse);
  rpc CompleteOperation(CompleteOperationRequest) returns (CompleteOperationResponse);

  rpc WatchOperations(WatchOperationsRequest) returns (stream OperationEvent);

  rpc SetDesiredNetworkV1(SetDesiredNetworkV1Request) returns (SetDesiredNetworkV1Response);
  rpc GetDesiredStateV1(GetDesiredStateV1Request) returns (GetDesiredStateV1Response);
  rpc GetClusterHealthV1(GetClusterHealthV1Request) returns (GetClusterHealthV1Response);
}

message DesiredNetwork {
  string domain = 1;
  string protocol = 2;
  uint32 port_http = 3;
  uint32 port_https = 4;
  bool acme_enabled = 5;
  string admin_email = 6;
  repeated string alternate_domains = 7;
}

message DesiredState {
  uint64 generation = 1;
  google.protobuf.Timestamp updated_at = 2;
  DesiredNetwork network = 3;
  map<string,string> service_versions = 4;
}

message SetDesiredNetworkV1Request { DesiredNetwork network = 1; }
message SetDesiredNetworkV1Response { DesiredState desired = 1; }

message GetDesiredStateV1Request {}
message GetDesiredStateV1Response { DesiredState desired = 1; }

message SetDesiredServiceVersionV1Request {
  string service_name = 1;
  string version = 2;
}
message SetDesiredServiceVersionV1Response {
  DesiredState desired = 1;
}

message ClearDesiredServiceVersionV1Request {
  string service_name = 1;
}
message ClearDesiredServiceVersionV1Response {
  DesiredState desired = 1;
}

message GetClusterHealthV1Request {
  string cluster_id = 1;
}

message NodeHealth {
  string node_id = 1;
  string desired_network_hash = 2;
  string applied_network_hash = 3;
  string desired_services_hash = 4;
  string applied_services_hash = 5;
  string current_plan_id = 6;
  uint64 current_plan_generation = 7;
  string current_plan_phase = 8;
  string last_error = 9;
}

message ServiceSummary {
  string service_name = 1;
  string desired_version = 2;
  int32 nodes_at_desired = 3;
  int32 nodes_total = 4;
  int32 upgrading = 5;
}

message GetClusterHealthV1Response {
  repeated NodeHealth nodes = 1;
  repeated ServiceSummary services = 2;
}
