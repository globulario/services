syntax = "proto3";

package nodeagent;

option go_package = "github.com/globulario/services/golang/nodeagent/nodeagentpb;nodeagentpb";

import "google/protobuf/timestamp.proto";
import "clustercontroller.proto";
import "plan.proto";

message JoinClusterRequest {
  string controller_endpoint = 1;
  string join_token = 2;
}
message JoinClusterResponse {
  string request_id = 1;
  string node_id = 2;
  string status = 3;
  string message = 4;
}

message InstalledComponent {
  string name = 1;
  string version = 2;
  bool installed = 3;
}

message UnitStatus {
  string name = 1;
  string state = 2;
  string details = 3;
}

message Inventory {
  clustercontroller.NodeIdentity identity = 1;
  google.protobuf.Timestamp unix_time = 2;
  repeated InstalledComponent components = 3;
  repeated UnitStatus units = 4;
}

message GetInventoryRequest {}
message GetInventoryResponse { Inventory inventory = 1; }

message ApplyPlanRequest {
  clustercontroller.NodePlan plan = 1;
  string operation_id = 2;
}
message ApplyPlanResponse {
  string operation_id = 1;
}

message ApplyPlanV1Request {
  globular.plan.v1.NodePlan plan = 1;
  string operation_id = 2; // optional; server will generate if empty
}
message ApplyPlanV1Response {
  string operation_id = 1; // always non-empty; returned even if client omitted
  string plan_id = 2;
  uint64 plan_generation = 3;
}

message GetPlanStatusV1Request {
  string node_id = 1; // optional: defaults to the node-agent's node id
}
message GetPlanStatusV1Response {
  globular.plan.v1.NodePlanStatus status = 1;
}

message WatchPlanStatusV1Request {
  string node_id = 1; // optional: defaults to the node-agent's node id
}

message WatchOperationRequest { string operation_id = 1; }

message OperationEvent {
  string operation_id = 1;
  clustercontroller.OperationPhase phase = 2;
  string message = 3;
  int32 percent = 4;
  bool done = 5;
  string error = 6;
  google.protobuf.Timestamp ts = 7;
}

message BootstrapFirstNodeRequest {
  string cluster_domain = 1;
  string controller_bind = 2;
  repeated string profiles = 3;
}
message BootstrapFirstNodeResponse {
  string operation_id = 1;
  string join_token = 2;
  string message = 3;
}

service NodeAgentService {
  rpc JoinCluster(JoinClusterRequest) returns (JoinClusterResponse);
  rpc GetInventory(GetInventoryRequest) returns (GetInventoryResponse);
  rpc ApplyPlan(ApplyPlanRequest) returns (ApplyPlanResponse);
  rpc ApplyPlanV1(ApplyPlanV1Request) returns (ApplyPlanV1Response);
  rpc GetPlanStatusV1(GetPlanStatusV1Request) returns (GetPlanStatusV1Response);
  rpc WatchPlanStatusV1(WatchPlanStatusV1Request) returns (stream globular.plan.v1.NodePlanStatus);
  rpc WatchOperation(WatchOperationRequest) returns (stream OperationEvent);
  rpc BootstrapFirstNode(BootstrapFirstNodeRequest) returns (BootstrapFirstNodeResponse);
}
