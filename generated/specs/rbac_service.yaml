version: 1

metadata:
  name: rbac

service:
  name: rbac
  exec: rbac_server

steps:
  - id: ensure-user-group
    type: ensure_user_group
    user: globular
    group: globular
    home: "{{.StateDir}}"
    shell: /usr/sbin/nologin
    system: true

  - id: ensure-dirs
    type: ensure_dirs
    dirs:
      - path: "{{.Prefix}}"
        owner: root
        group: root
        mode: 0755
      - path: "{{.Prefix}}/bin"
        owner: root
        group: root
        mode: 0755

      - path: "{{.StateDir}}"
        owner: globular
        group: globular
        mode: 0750
      - path: "{{.StateDir}}/services"
        owner: globular
        group: globular
        mode: 0750
      - path: "{{.StateDir}}/rbac"
        owner: globular
        group: globular
        mode: 0750

      # TLS directories (certificates must be provisioned by Day-0 bootstrap)
      - path: "{{.StateDir}}/pki"
        owner: globular
        group: globular
        mode: 0750
      - path: "{{.StateDir}}/config/tls"
        owner: globular
        group: globular
        mode: 0750

  - id: install-rbac-payload
    type: install_package_payload
    install_bins: true
    install_config: false
    install_spec: false
    install_systemd: false

  - id: ensure-rbac-config
    type: ensure_service_config
    service_name: rbac
    exec: rbac_server
    address_host: auto
    rewrite_if_out_of_range: true

  - id: install-rbac-service
    type: install_services
    units:
      - name: globular-rbac.service
        owner: root
        group: root
        mode: 0644
        atomic: true
        content: |
          [Unit]
          Description=Globular rbac
          After=network-online.target scylla-server.service
          Wants=network-online.target scylla-server.service

          [Service]
          Type=simple
          User=globular
          Group=globular
          WorkingDirectory={{.StateDir}}/rbac
          Environment=GLOBULAR_SERVICES_DIR={{.StateDir}}/services
          Environment=GLOBULAR_BOOTSTRAP=1
          ExecStartPre=/bin/sh -c 'for i in $(seq 1 90); do ss -lnt | grep -q ":9042 " && exit 0; sleep 1; done; echo "scylla 9042 not ready"; exit 1'
          ExecStart={{.Prefix}}/bin/rbac_server
          Restart=on-failure
          RestartSec=2
          LimitNOFILE=524288

          [Install]
          WantedBy=multi-user.target

  - id: enable-rbac
    type: enable_services
    services:
      - globular-rbac.service

  - id: start-rbac
    type: start_services
    services:
      - globular-rbac.service
    binaries:
      globular-rbac.service: rbac_server

  - id: health-rbac
    type: health_checks
    services:
      - globular-rbac.service
